<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shalom Kids - Kuis Alkitab</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            overflow-x: hidden;
            background-color: #E0F7FA;
            user-select: none;
        }

        /* Scenery & Animation */
        .scenery {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45vh;
            z-index: -1;
            pointer-events: none;
        }

        .grass {
            fill: #AED581;
        }

        .church {
            fill: #FFF9C4;
            stroke: #FFB74D;
            stroke-width: 2px;
        }

        .roof {
            fill: #FF8A65;
        }

        .cloud {
            fill: #FFFFFF;
            opacity: 0.8;
            animation: moveCloud 35s linear infinite;
        }

        @keyframes moveCloud {
            from {
                transform: translateX(-150px);
            }

            to {
                transform: translateX(100vw);
            }
        }

        /* UI Components */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-soft {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            border: 4px solid #B2EBF2;
        }

        .btn-action {
            transition: all 0.2s;
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        /* Avatar Selection */
        .avatar-option {
            transition: all 0.2s;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .avatar-option:hover {
            transform: scale(1.05);
        }

        .avatar-option.selected {
            border-color: #3B82F6;
            background-color: #EFF6FF;
            transform: scale(1.1);
            z-index: 10;
        }

        .avatar-locked {
            opacity: 0.7;
            background-color: #E5E7EB;
        }

        .lock-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #4B5563;
            font-size: 10px;
            font-weight: bold;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #81D4FA;
            border-radius: 10px;
        }

        /* Match Game */
        .match-item.selected {
            background-color: #FEF3C7;
            border-color: #F59E0B;
            transform: scale(1.02);
        }

        .match-item.matched {
            background-color: #D1FAE5;
            border-color: #10B981;
            opacity: 0.6;
            pointer-events: none;
        }

        .role-btn:hover {
            transform: translateY(-5px);
        }

        /* Teacher Tabs */
        .tab-btn.active {
            background-color: #7C3AED;
            color: white;
        }

        .tab-btn {
            background-color: #EDE9FE;
            color: #6D28D9;
        }
    </style>
</head>

<body class="text-gray-700 h-screen flex flex-col">

    <!-- Background -->
    <svg class="scenery" preserveAspectRatio="none" viewBox="0 0 1000 300">
        <rect width="100%" height="100%" fill="#E0F7FA" />
        <circle cx="900" cy="50" r="40" fill="#FFF176" />
        <path class="grass" d="M0,220 Q250,180 500,220 T1000,220 V300 H0 Z" />
        <g transform="translate(420, 140) scale(1.6)">
            <rect x="20" y="40" width="60" height="60" class="church" />
            <path d="M10,40 L50,0 L90,40 Z" class="roof" />
            <rect x="40" y="70" width="20" height="30" fill="#8D6E63" rx="5" />
            <rect x="40" y="-15" width="20" height="40" class="church" />
            <path d="M30,-15 L50,-40 L70,-15 Z" class="roof" />
            <rect x="48" y="-35" width="4" height="15" fill="#FFB74D" />
            <rect x="42" y="-30" width="16" height="4" fill="#FFB74D" />
        </g>
        <path class="cloud" d="M10,50 Q30,30 50,50 T90,50 T120,50 V60 H10 Z" transform="translate(50, 20)" />
        <path class="cloud" d="M10,50 Q30,30 50,50 T90,50 T120,50 V60 H10 Z"
            transform="translate(600, 40) scale(1.5)" />
    </svg>

    <!-- Header (Hidden on Login) -->
    <header id="mainHeader"
        class="hidden px-4 py-3 flex justify-between items-center bg-white/90 sticky top-0 z-50 shadow-sm backdrop-blur-md">
        <div class="flex items-center gap-2">
            <div class="bg-blue-100 p-2 rounded-full text-blue-600"><i data-lucide="church" class="w-5 h-5"></i></div>
            <h1 class="font-extrabold text-lg text-blue-600 hidden sm:block tracking-tight">Shalom Kids</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleMusic()" id="musicBtn"
                class="p-2 rounded-full bg-yellow-100 text-yellow-600 hover:bg-yellow-200 transition btn-action">
                <i data-lucide="music" class="w-5 h-5"></i>
            </button>
            <div id="pointBadge"
                class="flex items-center gap-2 bg-yellow-50 px-3 py-1.5 rounded-full border-2 border-yellow-200 shadow-sm">
                <i data-lucide="star" class="text-yellow-500 fill-yellow-500 w-4 h-4"></i>
                <span id="scoreDisplay" class="font-bold text-yellow-700 text-sm">0</span>
            </div>
            <button onclick="goToDashboard()"
                class="p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition btn-action">
                <i data-lucide="home" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Content -->
    <main id="app" class="flex-grow p-4 md:p-6 flex justify-center overflow-y-auto pb-24">

        <!-- 1. ROLE SELECTION -->
        <section id="roleSelection" class="w-full max-w-2xl flex flex-col items-center justify-center fade-in py-10">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-black text-blue-600 mb-2 drop-shadow-sm tracking-tight">Shalom Kids</h1>
                <p class="text-gray-500">Pilih profilmu untuk memulai</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 w-full px-4">
                <!-- Student Role -->
                <button onclick="selectRole('student')"
                    class="role-btn card-soft p-8 flex flex-col items-center gap-4 hover:bg-blue-50 transition border-blue-200 cursor-pointer">
                    <div
                        class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 shadow-inner">
                        <i data-lucide="smile" class="w-12 h-12"></i>
                    </div>
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800">Murid</h2>
                        <p class="text-sm text-gray-400">Masuk untuk bermain</p>
                    </div>
                </button>

                <!-- Teacher Role -->
                <button onclick="selectRole('teacher')"
                    class="role-btn card-soft p-8 flex flex-col items-center gap-4 hover:bg-purple-50 transition border-purple-200 cursor-pointer">
                    <div
                        class="w-24 h-24 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 shadow-inner">
                        <i data-lucide="book-open" class="w-12 h-12"></i>
                    </div>
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800">Guru</h2>
                        <p class="text-sm text-gray-400">Masuk untuk buat soal</p>
                    </div>
                </button>
            </div>
        </section>

        <!-- 2. STUDENT LOGIN (SETUP PROFILE) -->
        <section id="studentLogin" class="w-full max-w-md hidden fade-in py-10">
            <div class="card-soft p-8 w-full text-center bg-white relative">
                <button onclick="showSection('roleSelection')"
                    class="absolute top-4 left-4 text-gray-400 hover:text-gray-600"><i
                        data-lucide="arrow-left"></i></button>

                <h2 class="text-2xl font-bold text-blue-600 mb-2">Buat Profilmu</h2>
                <p class="text-gray-400 text-sm mb-6">Pilih ikon dan isi nama</p>

                <!-- Avatar Selection Grid -->
                <div class="grid grid-cols-3 gap-3 mb-6" id="loginAvatarGrid">
                    <!-- Injected by JS -->
                </div>

                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Nama Panggilan</label>
                        <input type="text" id="inputName"
                            class="w-full p-4 rounded-xl border-2 border-gray-100 focus:border-blue-400 outline-none font-bold text-gray-700 bg-gray-50 placeholder-gray-300"
                            placeholder="Ketik namamu...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Kode Kuis</label>
                        <input type="number" id="inputCode"
                            class="w-full p-4 rounded-xl border-2 border-gray-100 focus:border-purple-400 outline-none font-bold text-gray-700 bg-gray-50 placeholder-gray-300"
                            placeholder="123456">
                    </div>
                    <button onclick="enterStudentApp()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg mt-2 flex justify-center items-center gap-2 btn-action">
                        Masuk <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 3. TEACHER LOGIN -->
        <section id="teacherLogin" class="w-full max-w-md hidden fade-in py-10">
            <div class="card-soft p-8 w-full text-center bg-white relative border-purple-300">
                <button onclick="showSection('roleSelection')"
                    class="absolute top-4 left-4 text-gray-400 hover:text-gray-600"><i
                        data-lucide="arrow-left"></i></button>
                <div
                    class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4 text-purple-600">
                    <i data-lucide="lock" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-purple-700 mb-2">Area Guru</h2>
                <p class="text-gray-400 text-sm mb-6">Masukkan kode akses untuk masuk.</p>

                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Kode Akses</label>
                        <input type="password" id="teacherPass"
                            class="w-full p-4 rounded-xl border-2 border-gray-100 focus:border-purple-500 outline-none font-bold text-gray-700 bg-gray-50 placeholder-gray-300"
                            placeholder="******">
                    </div>
                    <button onclick="enterTeacherApp()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-xl shadow-lg mt-2 flex justify-center items-center gap-2 btn-action">
                        Buka Dashboard <i data-lucide="key" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 4. STUDENT HOME -->
        <section id="home" class="w-full max-w-xl text-center flex flex-col items-center pt-4 hidden fade-in">
            <!-- Profile Display -->
            <div class="mb-8 flex flex-col items-center gap-3">
                <div class="w-32 h-32 bg-white rounded-full border-[6px] border-blue-200 flex items-center justify-center shadow-xl overflow-hidden p-2"
                    id="homeAvatarDisplay">
                    <!-- Selected SVG rendered here -->
                </div>
                <h2 class="text-3xl font-black text-gray-800">Halo, <span class="text-blue-600"
                        id="displayName">Teman</span>!</h2>
                <p class="text-gray-500 font-bold bg-white px-4 py-1 rounded-full shadow-sm text-sm border">Poin Kamu:
                    <span id="homePoints">0</span>
                </p>
            </div>

            <h1 class="text-2xl font-bold text-blue-600 mb-6 drop-shadow-sm tracking-tight">Mau ngapain hari ini?</h1>

            <div class="grid grid-cols-2 gap-4 w-full">
                <button onclick="startGame()"
                    class="card-soft p-6 flex flex-col items-center gap-2 hover:bg-blue-50 btn-action group cursor-pointer col-span-2">
                    <div class="bg-blue-500 text-white p-4 rounded-2xl shadow-lg group-hover:scale-110 transition"><i
                            data-lucide="play" class="w-8 h-8"></i></div>
                    <span class="font-bold text-xl text-blue-700">Mulai Kuis</span>
                </button>

                <button onclick="openProfileEditor()"
                    class="card-soft p-5 flex flex-col items-center gap-2 hover:bg-green-50 btn-action group cursor-pointer">
                    <div class="bg-green-500 text-white p-3 rounded-2xl shadow-lg group-hover:scale-110 transition"><i
                            data-lucide="shopping-bag" class="w-6 h-6"></i></div>
                    <span class="font-bold text-green-700">Toko Profil</span>
                </button>

                <button onclick="showSection('about')"
                    class="card-soft p-5 flex flex-col items-center gap-2 hover:bg-orange-50 btn-action group cursor-pointer">
                    <div class="bg-orange-500 text-white p-3 rounded-2xl shadow-lg group-hover:scale-110 transition"><i
                            data-lucide="info" class="w-6 h-6"></i></div>
                    <span class="font-bold text-orange-700">Info</span>
                </button>
            </div>

            <button onclick="logout()"
                class="mt-10 text-sm text-red-400 hover:text-red-600 font-bold flex items-center gap-1 border border-red-200 px-4 py-2 rounded-full hover:bg-red-50 transition">
                <i data-lucide="log-out" class="w-4 h-4"></i> Keluar / Ganti Akun
            </button>
        </section>

        <!-- 5. PROFILE EDITOR SECTION -->
        <section id="profileEditor" class="w-full max-w-md hidden fade-in py-10">
            <div class="card-soft p-8 w-full text-center bg-white relative">
                <button onclick="showSection('home')" class="absolute top-4 left-4 text-gray-400 hover:text-gray-600"><i
                        data-lucide="arrow-left"></i></button>

                <div class="flex items-center justify-center gap-2 mb-2">
                    <h2 class="text-2xl font-bold text-green-600">Toko Profil</h2>
                    <div class="bg-yellow-100 px-2 py-1 rounded text-xs font-bold text-yellow-700 flex items-center">
                        <i data-lucide="star" class="w-3 h-3 mr-1 fill-yellow-600"></i> <span id="shopPoints">0</span>
                    </div>
                </div>
                <p class="text-gray-400 text-sm mb-6">Beli ikon baru dengan poinmu!</p>

                <!-- Avatar Selection Grid -->
                <div class="grid grid-cols-3 gap-3 mb-6" id="editAvatarGrid">
                    <!-- Injected by JS -->
                </div>

                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Ganti Nama</label>
                        <input type="text" id="editInputName"
                            class="w-full p-4 rounded-xl border-2 border-gray-100 focus:border-green-400 outline-none font-bold text-gray-700 bg-gray-50 placeholder-gray-300"
                            placeholder="Ketik namamu...">
                    </div>
                    <button onclick="saveProfile()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg mt-2 flex justify-center items-center gap-2 btn-action">
                        Simpan Perubahan <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 6. TEACHER DASHBOARD (UPDATED) -->
        <section id="teacherDashboard" class="w-full max-w-4xl hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black text-purple-700">Ruang Guru</h2>
                    <p class="text-sm text-gray-500">Kelola soal dan nilai murid</p>
                </div>
                <button onclick="logout()"
                    class="bg-red-100 text-red-500 px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-200">Keluar</button>
            </div>

            <!-- Quiz Code Generator -->
            <div
                class="bg-purple-50 border-2 border-purple-200 p-6 rounded-2xl mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-center sm:text-left">
                    <div class="text-xs font-bold text-purple-400 uppercase tracking-wider mb-1">Kode Kuis Aktif</div>
                    <div id="teacherCodeDisplay" class="text-4xl font-black text-purple-800 tracking-widest">123456
                    </div>
                </div>
                <button onclick="generateNewCode()"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl font-bold shadow-md btn-action flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i> Ganti Kode
                </button>
            </div>

            <!-- TABS -->
            <div class="flex gap-2 mb-4">
                <button onclick="switchTeacherTab('editor')" id="tabEditor"
                    class="tab-btn active px-6 py-2 rounded-full font-bold text-sm transition">Editor Soal</button>
                <button onclick="switchTeacherTab('grades')" id="tabGrades"
                    class="tab-btn px-6 py-2 rounded-full font-bold text-sm transition">Rekap Nilai</button>
            </div>

            <!-- TAB CONTENT: EDITOR -->
            <div id="contentEditor" class="space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="edit-3" class="w-5 h-5 text-green-600"></i> Buat Soal Baru
                    </h3>
                    <div class="grid gap-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="sm:col-span-1">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Tipe Soal</label>
                                <select id="editType"
                                    class="w-full p-2.5 rounded-xl border border-gray-300 focus:border-green-500 outline-none text-sm bg-gray-50"
                                    onchange="updateEditorFields()">
                                    <option value="choice">Pilihan Ganda</option>
                                    <option value="text">Isian Singkat</option>
                                    <option value="essay">Uraian / Esai</option>
                                    <option value="complex">PG Kompleks (Centang)</option>
                                    <option value="match">Menjodohkan</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Pertanyaan</label>
                                <input type="text" id="editQuestion"
                                    class="w-full p-2.5 rounded-xl border border-gray-300 focus:border-green-500 outline-none text-sm"
                                    placeholder="Contoh: Siapa nama ibu Yesus?">
                            </div>
                        </div>

                        <div id="editAnswerArea" class="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2">
                        </div>

                        <button onclick="addCustomQuestion()"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded-xl shadow-md w-full text-sm flex justify-center items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> Simpan Soal
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">Daftar Soal</h3>
                    <button onclick="resetQuestions()"
                        class="text-red-500 text-xs font-bold hover:bg-red-50 px-3 py-1 rounded-lg border border-red-200">Reset
                        ke Default</button>
                </div>
                <div id="questionList" class="space-y-2 pb-10"></div>
            </div>

            <!-- TAB CONTENT: GRADES -->
            <div id="contentGrades" class="hidden space-y-6">
                <!-- Submission List -->
                <div id="submissionList" class="space-y-3">
                    <!-- Injected via JS -->
                </div>
                <!-- Grading Detail Modal (Inline) -->
                <div id="gradingDetail" class="hidden bg-white border-2 border-purple-200 rounded-2xl p-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4 border-b pb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800" id="gradingStudentName">Nama Murid</h3>
                            <p class="text-sm text-gray-500" id="gradingDate">Waktu</p>
                        </div>
                        <div class="text-right">
                            <span class="text-3xl font-black text-purple-600" id="gradingTotalScore">0</span>
                            <span class="text-gray-400 text-sm block">Nilai Akhir</span>
                        </div>
                    </div>
                    <div id="gradingQuestions" class="space-y-4 mb-6 max-h-[50vh] overflow-y-auto">
                        <!-- Questions List -->
                    </div>
                    <div class="flex gap-2">
                        <button onclick="closeGrading()"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl">Tutup</button>
                    </div>
                </div>
            </div>

        </section>

        <!-- 7. GAME SECTION -->
        <section id="game" class="w-full max-w-2xl hidden fade-in">
            <div class="card-soft p-6">
                <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-dashed border-blue-200">
                    <span class="text-blue-400 font-extrabold tracking-wide" id="questionCounter">SOAL 1/10</span>
                    <span
                        class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider"
                        id="questionTypeBadge">Pilihan Ganda</span>
                </div>

                <h2 id="questionText" class="text-xl md:text-2xl font-bold text-gray-800 mb-6 leading-relaxed">
                    Pertanyaan...</h2>
                <div id="answerArea" class="space-y-3"></div>
                <div id="feedbackArea"
                    class="hidden mt-6 p-4 rounded-xl text-center font-bold text-lg animate-pulse border-2"></div>

                <div class="mt-8 flex justify-end">
                    <button id="nextBtn" onclick="nextQuestion()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg btn-action hidden flex items-center gap-2">
                        Lanjut <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                    <button id="submitBtn" onclick="checkAnswer()"
                        class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg btn-action">
                        Jawab
                    </button>
                </div>
            </div>
        </section>

        <!-- 8. ABOUT SECTION -->
        <section id="about" class="w-full max-w-xl hidden fade-in text-center pt-10">
            <div class="card-soft p-8">
                <div
                    class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500">
                    <i data-lucide="heart" class="w-8 h-8 fill-blue-500"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Tentang Shalom Kids</h2>
                <p class="text-gray-500 text-sm mb-6 leading-relaxed">
                    Aplikasi ini dibuat khusus untuk anak-anak agar lebih semangat belajar Alkitab.
                    Gratis, interaktif, dan bisa dimainkan di mana saja.
                </p>
                <div class="text-xs text-gray-400 font-mono bg-gray-100 p-2 rounded-lg inline-block">
                    Versi 6.0 Teacher Grade â€¢ Shalom Kids
                </div>
                <button onclick="showSection('home')"
                    class="block w-full mt-4 text-blue-500 font-bold text-sm">Kembali</button>
            </div>
        </section>

    </main>

    <!-- Modal -->
    <div id="modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] hidden p-4">
        <div
            class="bg-white p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center transform scale-100 transition-all border-4 border-white">
            <div id="modalIcon"
                class="mx-auto w-14 h-14 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-blue-500">
                <i data-lucide="info" class="w-7 h-7"></i>
            </div>
            <h3 id="modalTitle" class="text-lg font-black text-gray-800 mb-2">Judul</h3>
            <p id="modalMsg" class="text-gray-500 text-sm mb-6 leading-relaxed">Pesan</p>
            <div id="modalActions">
                <button onclick="closeModal()"
                    class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold w-full hover:bg-black transition text-sm">Oke,
                    Mengerti</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA & CONFIGURATION ---
        lucide.createIcons();

        // --- RELIGIOUS SYMBOLS AVATARS WITH PRICES ---
        const avatars = [
            { id: 'star', price: 0, svg: '<path d="M50,15 L60,40 L90,40 L65,60 L75,90 L50,70 L25,90 L35,60 L10,40 L40,40 Z" fill="#FFF176" stroke="#FBC02D" stroke-width="3"/>' },
            { id: 'heart', price: 30, svg: '<path d="M50,85 L45,80 Q10,45 25,25 Q35,10 50,30 Q65,10 75,25 Q90,45 55,80 Z" fill="#F48FB1" stroke="#E91E63" stroke-width="2"/>' },
            { id: 'candle', price: 50, svg: '<rect x="40" y="40" width="20" height="50" fill="#FFF9C4" stroke="#FBC02D"/><path d="M50,40 L50,30" stroke="#333" stroke-width="2"/><path d="M50,30 Q55,20 50,10 Q45,20 50,30" fill="#FF5722"/><circle cx="50" cy="20" r="8" fill="#FFC107" opacity="0.5"/>' },
            { id: 'dandelion', price: 60, svg: '<path d="M50,90 Q55,70 50,50" stroke="#81C784" stroke-width="2" fill="none"/><circle cx="50" cy="45" r="15" fill="#E0F7FA" opacity="0.8"/><line x1="50" y1="45" x2="50" y2="25" stroke="#B0BEC5" stroke-width="1"/><line x1="50" y1="45" x2="70" y2="45" stroke="#B0BEC5" stroke-width="1"/><line x1="50" y1="45" x2="30" y2="45" stroke="#B0BEC5" stroke-width="1"/><line x1="50" y1="45" x2="65" y2="30" stroke="#B0BEC5" stroke-width="1"/><line x1="50" y1="45" x2="35" y2="30" stroke="#B0BEC5" stroke-width="1"/><line x1="50" y1="45" x2="65" y2="60" stroke="#B0BEC5" stroke-width="1"/><line x1="50" y1="45" x2="35" y2="60" stroke="#B0BEC5" stroke-width="1"/>' },
            { id: 'book', price: 80, svg: '<rect x="25" y="15" width="50" height="70" rx="3" fill="#5D4037" stroke="#3E2723" stroke-width="2"/><path d="M22,15 L28,15 L28,85 L22,85 Z" fill="#3E2723"/><text x="50" y="45" font-family="Nunito, sans-serif" font-size="12" fill="#FFD700" text-anchor="middle" font-weight="900" style="text-shadow: 1px 1px 0px rgba(0,0,0,0.3);">BIBLE</text><path d="M50,55 L50,75 M42,62 L58,62" stroke="#FFD700" stroke-width="2" stroke-linecap="round"/>' },
            { id: 'cross', price: 100, svg: '<rect x="45" y="15" width="10" height="70" fill="#D7CCC8" stroke="#8D6E63" stroke-width="2"/><rect x="30" y="30" width="40" height="10" fill="#D7CCC8" stroke="#8D6E63" stroke-width="2"/>' }
        ];

        // State Init
        let userName = localStorage.getItem('sm_username') || '';

        // Update: Poin menjadi 0
        let storedPoints = localStorage.getItem('sm_points');
        let points = storedPoints ? parseInt(storedPoints) : 0;

        let currentAvatar = localStorage.getItem('sm_avatar') || 'star';
        let ownedAvatars = JSON.parse(localStorage.getItem('sm_owned_avatars') || '["star"]');

        let questions = JSON.parse(localStorage.getItem('sm_questions') || '[]');
        let currentQuizCode = localStorage.getItem('sm_quiz_code') || '123456';
        let currentRole = 'none';
        let currentQuestionIndex = 0;
        let scoreInGame = 0;
        let selectedAvatarTemp = 'star';

        // Submissions & Answers Tracking
        let sessionAnswers = [];
        let allSubmissions = JSON.parse(localStorage.getItem('sm_submissions') || '[]');

        // Default Questions
        if (questions.length === 0) {
            questions = [
                { id: 1, type: 'choice', question: 'Siapakah yang membangun bahtera besar?', options: ['Musa', 'Nuh', 'Abraham', 'Daud'], answer: 'Nuh' },
                { id: 2, type: 'text', question: 'Ada berapa murid Tuhan Yesus? (Angka)', answer: '12' },
                { id: 3, type: 'match', question: 'Jodohkan!', pairs: [{ left: 'Goliat', right: 'Raksasa' }, { left: 'Daud', right: 'Raja' }, { left: 'Musa', right: 'Nabi' }] },
                { id: 4, type: 'complex', question: 'Hewan apa yang ada di kandang domba saat Yesus lahir? (Pilih 2)', options: ['Domba', 'Singa', 'Lembu', 'Dinosaurus'], answer: ['Domba', 'Lembu'] },
                { id: 5, type: 'essay', question: 'Mengapa kita harus mengasihi teman?', answer: 'karena tuhan mengasihi kita' }
            ];
            localStorage.setItem('sm_questions', JSON.stringify(questions));
        }

        if (!ownedAvatars.includes('star')) {
            ownedAvatars.push('star');
            localStorage.setItem('sm_owned_avatars', JSON.stringify(ownedAvatars));
        }

        // --- AUDIO SYSTEM ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let isMusicPlaying = false;
        let melodyInterval;

        function playTone(freq, dur, type = 'sine') {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        }

        function toggleMusic() {
            isMusicPlaying = !isMusicPlaying;
            const btn = document.getElementById('musicBtn');
            if (isMusicPlaying) {
                btn.classList.replace('bg-yellow-100', 'bg-green-100');
                btn.classList.replace('text-yellow-600', 'text-green-600');
                startMelody();
            } else {
                btn.classList.replace('bg-green-100', 'bg-yellow-100');
                btn.classList.replace('text-green-600', 'text-yellow-600');
                clearInterval(melodyInterval);
            }
        }

        function startMelody() {
            const notes = [392, 329, 329, 293, 329, 392, 392, 329, 329, 293, 329, 392];
            let i = 0;
            melodyInterval = setInterval(() => {
                playTone(notes[i % notes.length], 0.4);
                i++;
            }, 600);
        }

        // --- AVATAR SYSTEM ---
        function renderAvatarSelection(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            avatars.forEach(av => {
                const isOwned = ownedAvatars.includes(av.id);
                const isSelected = selectedAvatarTemp === av.id;
                const div = document.createElement('div');
                div.className = `avatar-option w-full aspect-square rounded-xl border-2 flex items-center justify-center cursor-pointer shadow-sm relative ${isSelected ? 'selected' : 'border-gray-200'} ${!isOwned ? 'avatar-locked' : 'bg-white'}`;
                let content = `<svg viewBox="0 0 100 100" class="w-10 h-10">${av.svg}</svg>`;
                if (!isOwned) {
                    content += `<div class="lock-overlay rounded-xl"><i data-lucide="lock" class="w-4 h-4 mb-1"></i><span>${av.price} P</span></div>`;
                }
                div.innerHTML = content;
                div.onclick = () => handleAvatarClick(av.id, av.price, containerId);
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function handleAvatarClick(id, price, containerId) {
            if (ownedAvatars.includes(id)) {
                selectedAvatarTemp = id;
                renderAvatarSelection(containerId);
            } else {
                if (points >= price) {
                    document.getElementById('modalActions').innerHTML = `<button onclick="confirmBuy('${id}', ${price}, '${containerId}')" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold mr-2">Beli (${price} P)</button><button onclick="closeModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold">Batal</button>`;
                    showModal('Beli Profil?', `Kamu ingin membeli ikon ini seharga ${price} Poin?`);
                } else {
                    document.getElementById('modalActions').innerHTML = `<button onclick="closeModal()" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold w-full">Oke</button>`;
                    showModal('Poin Kurang', `Kamu butuh ${price} Poin. Poinmu sekarang ${points}. Ayo main kuis dulu!`);
                }
            }
        }

        function confirmBuy(id, price, containerId) {
            points -= price;
            ownedAvatars.push(id);
            localStorage.setItem('sm_points', points);
            localStorage.setItem('sm_owned_avatars', JSON.stringify(ownedAvatars));
            selectedAvatarTemp = id;
            closeModal();
            updateUI();
            renderAvatarSelection(containerId);
            playTone(800, 0.1); setTimeout(() => playTone(1200, 0.2), 100);
        }

        function getAvatarSVG(id) {
            const av = avatars.find(a => a.id === id);
            return av ? `<svg viewBox="0 0 100 100" class="w-full h-full">${av.svg}</svg>` : '';
        }

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = points;
            document.getElementById('homePoints').innerText = points;
            document.getElementById('shopPoints').innerText = points;
            document.getElementById('displayName').innerText = userName || "Teman";
            document.getElementById('teacherCodeDisplay').innerText = currentQuizCode;
            const homeAv = document.getElementById('homeAvatarDisplay');
            if (homeAv) homeAv.innerHTML = getAvatarSVG(currentAvatar);
        }

        // --- AUTH & FLOW ---
        function selectRole(role) {
            if (role === 'student') {
                if (ownedAvatars.includes(currentAvatar)) selectedAvatarTemp = currentAvatar;
                else selectedAvatarTemp = 'star';
                renderAvatarSelection('loginAvatarGrid');
                showSection('studentLogin');
            } else {
                showSection('teacherLogin');
            }
        }

        function enterStudentApp() {
            const name = document.getElementById('inputName').value.trim();
            const code = document.getElementById('inputCode').value.trim();
            if (!name) { showModal('Halo!', 'Siapa namamu? Isi dulu ya.'); return; }
            if (code && code !== currentQuizCode) { showModal('Ups!', 'Kode Kuis salah. Coba tanya gurumu.'); return; }
            userName = name;
            currentAvatar = selectedAvatarTemp;
            localStorage.setItem('sm_username', userName);
            localStorage.setItem('sm_avatar', currentAvatar);
            currentRole = 'student';
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('pointBadge').classList.remove('hidden');
            showSection('home');
            updateUI();
        }

        function enterTeacherApp() {
            const pass = document.getElementById('teacherPass').value;
            // Simple Base64 obfuscation for "Shalom" -> "U2hhbG9t"
            // This is not high security, but better than plain text for kids/casual users.
            if (btoa(pass) === 'U2hhbG9t') {
                currentRole = 'teacher';
                document.getElementById('mainHeader').classList.remove('hidden');
                document.getElementById('pointBadge').classList.add('hidden');
                showSection('teacherDashboard');
                updateUI();
                renderSubmissionList(); // Load submissions
                document.getElementById('teacherPass').value = '';
            } else {
                showModal('Akses Ditolak', 'Kata sandi salah. Kode: Shalom');
            }
        }

        function openProfileEditor() {
            document.getElementById('editInputName').value = userName;
            selectedAvatarTemp = currentAvatar;
            renderAvatarSelection('editAvatarGrid');
            showSection('profileEditor');
        }

        function saveProfile() {
            const newName = document.getElementById('editInputName').value.trim();
            if (!newName) { showModal('Ups', 'Nama tidak boleh kosong.'); return; }
            userName = newName;
            currentAvatar = selectedAvatarTemp;
            localStorage.setItem('sm_username', userName);
            localStorage.setItem('sm_avatar', currentAvatar);
            showSection('home');
            updateUI();
            showModal('Sukses', 'Profil berhasil disimpan!');
        }

        function logout() {
            currentRole = 'none';
            document.getElementById('mainHeader').classList.add('hidden');
            showSection('roleSelection');
        }

        function generateNewCode() {
            const newCode = Math.floor(100000 + Math.random() * 900000).toString();
            currentQuizCode = newCode;
            localStorage.setItem('sm_quiz_code', newCode);
            updateUI();
            showModal('Kode Baru', `Kode kuis berhasil diganti menjadi ${newCode}`);
        }

        function goToDashboard() {
            if (currentRole === 'teacher') showSection('teacherDashboard');
            else showSection('home');
        }

        // --- TEACHER DASHBOARD LOGIC ---
        function switchTeacherTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'bg-purple-600', 'text-white'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.add('bg-purple-100', 'text-purple-700'));

            if (tab === 'editor') {
                document.getElementById('tabEditor').classList.add('active', 'bg-purple-600', 'text-white');
                document.getElementById('contentEditor').classList.remove('hidden');
                document.getElementById('contentGrades').classList.add('hidden');
                renderQuestionList();
            } else {
                document.getElementById('tabGrades').classList.add('active', 'bg-purple-600', 'text-white');
                document.getElementById('contentEditor').classList.add('hidden');
                document.getElementById('contentGrades').classList.remove('hidden');
                renderSubmissionList();
            }
        }

        function renderSubmissionList() {
            const container = document.getElementById('submissionList');
            container.innerHTML = '';

            if (allSubmissions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 p-4">Belum ada murid yang mengerjakan.</div>';
                return;
            }

            // Sort by date (newest first)
            allSubmissions.sort((a, b) => new Date(b.date) - new Date(a.date));

            allSubmissions.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center hover:bg-gray-50 cursor-pointer transition';
                div.onclick = () => openGrading(sub.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold">
                            ${sub.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">${sub.name}</div>
                            <div class="text-xs text-gray-400">${sub.date}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-black text-purple-600">${sub.score}</div>
                        <div class="text-xs text-gray-400">Poin</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        let currentGradingSubId = null;

        function openGrading(id) {
            currentGradingSubId = id;
            const sub = allSubmissions.find(s => s.id === id);
            if (!sub) return;

            document.getElementById('submissionList').classList.add('hidden');
            document.getElementById('gradingDetail').classList.remove('hidden');

            document.getElementById('gradingStudentName').innerText = sub.name;
            document.getElementById('gradingDate').innerText = sub.date;
            document.getElementById('gradingTotalScore').innerText = sub.score;

            const qContainer = document.getElementById('gradingQuestions');
            qContainer.innerHTML = '';

            sub.answers.forEach((ans, idx) => {
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg border-l-4 ${ans.correct ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'} mb-2`;

                let answerDisplay = ans.answer;
                if (Array.isArray(answerDisplay)) answerDisplay = answerDisplay.join(', ');

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="w-full">
                            <p class="text-xs font-bold text-gray-500 mb-1">Soal ${idx + 1} (${ans.type})</p>
                            <p class="font-semibold text-gray-800 mb-1">${ans.qText}</p>
                            <p class="text-sm text-gray-600">Jawaban: <span class="font-bold">${answerDisplay}</span></p>
                        </div>
                        <button onclick="toggleAnswerCorrect(${idx})" class="ml-2 p-2 rounded-full ${ans.correct ? 'bg-green-200 text-green-700' : 'bg-red-200 text-red-700'} hover:opacity-80 transition" title="Ubah Status Benar/Salah">
                            <i data-lucide="${ans.correct ? 'check' : 'x'}" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                qContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        function toggleAnswerCorrect(idx) {
            const subIndex = allSubmissions.findIndex(s => s.id === currentGradingSubId);
            if (subIndex === -1) return;

            const sub = allSubmissions[subIndex];
            const ans = sub.answers[idx];

            // Toggle Logic
            if (ans.correct) {
                ans.correct = false;
                sub.score -= 10; // Assuming 10 points per question
            } else {
                ans.correct = true;
                sub.score += 10;
            }

            // Save
            allSubmissions[subIndex] = sub;
            localStorage.setItem('sm_submissions', JSON.stringify(allSubmissions));

            // Re-render
            openGrading(currentGradingSubId);
        }

        function closeGrading() {
            document.getElementById('gradingDetail').classList.add('hidden');
            document.getElementById('submissionList').classList.remove('hidden');
            renderSubmissionList();
        }

        // --- GAME LOGIC ---
        function startGame() {
            if (questions.length === 0) return showModal('Ups', 'Belum ada soal.');
            currentQuestionIndex = 0;
            scoreInGame = 0;
            sessionAnswers = []; // Reset answers tracker
            questions.sort(() => Math.random() - 0.5);
            showSection('game');
            loadQuestion();
        }

        function loadQuestion() {
            const q = questions[currentQuestionIndex];
            const area = document.getElementById('answerArea');
            const feedback = document.getElementById('feedbackArea');

            feedback.className = 'hidden mt-6 p-4 rounded-xl text-center font-bold text-lg animate-pulse border-2';
            feedback.innerHTML = '';
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');
            document.getElementById('questionCounter').innerText = `SOAL ${currentQuestionIndex + 1}/${questions.length}`;
            document.getElementById('questionTypeBadge').innerText = q.type.toUpperCase();
            document.getElementById('questionText').innerText = q.question;
            area.innerHTML = '';

            if (q.type === 'choice') {
                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-4 rounded-xl border-2 border-gray-100 hover:border-blue-400 hover:bg-blue-50 transition font-medium text-gray-600 choice-btn';
                    btn.innerText = opt;
                    btn.onclick = () => {
                        document.querySelectorAll('.choice-btn').forEach(b => { b.classList.remove('border-blue-500', 'bg-blue-100', 'text-blue-700'); b.dataset.selected = 'false'; });
                        btn.classList.add('border-blue-500', 'bg-blue-100', 'text-blue-700');
                        btn.dataset.selected = 'true';
                    };
                    area.appendChild(btn);
                });
            } else if (q.type === 'text' || q.type === 'essay') {
                area.innerHTML = `<input type="text" id="textAns" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-lg" placeholder="Jawabanmu...">`;
            } else if (q.type === 'complex') {
                q.options.forEach(opt => {
                    area.innerHTML += `<label class="flex items-center p-3 border-2 border-gray-100 rounded-xl hover:bg-gray-50 cursor-pointer"><input type="checkbox" value="${opt}" class="w-5 h-5 text-blue-600 rounded mr-3"><span class="font-medium">${opt}</span></label>`;
                });
            } else if (q.type === 'match') {
                const grid = document.createElement('div'); grid.className = 'grid grid-cols-2 gap-4';
                const rights = [...q.pairs].sort(() => Math.random() - 0.5);
                const leftDiv = document.createElement('div'); leftDiv.className = 'space-y-2';
                q.pairs.forEach(p => {
                    const b = document.createElement('div'); b.className = 'match-item p-3 border-2 border-blue-100 rounded-xl text-center font-bold text-sm bg-white hover:border-blue-300';
                    b.innerText = p.left; b.dataset.val = p.left; b.dataset.side = 'left'; b.onclick = (e) => handleMatch(e.target); leftDiv.appendChild(b);
                });
                const rightDiv = document.createElement('div'); rightDiv.className = 'space-y-2';
                rights.forEach(p => {
                    const b = document.createElement('div'); b.className = 'match-item p-3 border-2 border-purple-100 rounded-xl text-center font-bold text-sm bg-white hover:border-purple-300';
                    b.innerText = p.right; b.dataset.val = p.left; b.dataset.side = 'right'; b.onclick = (e) => handleMatch(e.target); rightDiv.appendChild(b);
                });
                grid.append(leftDiv, rightDiv); area.appendChild(grid); area.dataset.matches = 0;
            }
        }

        function handleMatch(el) {
            if (el.classList.contains('matched')) return;
            const area = document.getElementById('answerArea');
            const side = el.dataset.side;
            area.querySelectorAll(`.match-item[data-side="${side}"]`).forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            const l = area.querySelector(`.match-item[data-side="left"].selected`);
            const r = area.querySelector(`.match-item[data-side="right"].selected`);
            if (l && r) {
                if (l.dataset.val === r.dataset.val) {
                    l.classList.add('matched'); r.classList.add('matched'); l.classList.remove('selected'); r.classList.remove('selected');
                    playTone(600, 0.1); setTimeout(() => playTone(800, 0.2), 100); area.dataset.matches = parseInt(area.dataset.matches) + 1;
                } else {
                    playTone(200, 0.2, 'sawtooth'); setTimeout(() => { l.classList.remove('selected'); r.classList.remove('selected'); }, 400);
                }
            }
        }

        function checkAnswer() {
            const q = questions[currentQuestionIndex];
            let isCorrect = false;
            let studentAns = '';

            if (q.type === 'choice') {
                const sel = document.querySelector('.choice-btn[data-selected="true"]');
                if (sel) {
                    studentAns = sel.innerText;
                    // Compare trimmed values to be safe
                    if (sel.innerText.trim() === q.answer.trim()) isCorrect = true;
                }
            } else if (q.type === 'text' || q.type === 'essay') {
                const ans = document.getElementById('textAns').value.trim();
                studentAns = ans;
                const key = q.answer.toLowerCase().trim();
                // Improved Loose matching for essay
                if (ans) {
                    const cleanAns = ans.toLowerCase().replace(/[.,!]/g, ''); // remove punctuation
                    const cleanKey = key.replace(/[.,!]/g, '');
                    if (q.type === 'essay') {
                        // If answer contains the keyword/key phrase
                        if (cleanAns.includes(cleanKey) || cleanKey.includes(cleanAns)) isCorrect = true;
                    } else {
                        // Strict but case-insensitive for 'text' (short answer)
                        if (cleanAns === cleanKey) isCorrect = true;
                    }
                }
            } else if (q.type === 'complex') {
                const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(c => c.value).sort();
                studentAns = checked;
                const key = [...q.answer].sort();
                if (JSON.stringify(checked) === JSON.stringify(key)) isCorrect = true;
            } else if (q.type === 'match') {
                studentAns = "Pasangan";
                // Ensure all pairs are found
                if (parseInt(document.getElementById('answerArea').dataset.matches) === q.pairs.length) isCorrect = true;
            }

            // Record Answer
            sessionAnswers.push({
                qId: q.id,
                qText: q.question,
                type: q.type,
                answer: studentAns,
                correct: isCorrect
            });

            const fb = document.getElementById('feedbackArea');
            fb.classList.remove('hidden');

            if (isCorrect) {
                fb.className = 'mt-6 p-4 rounded-xl text-center font-bold text-lg border-2 bg-green-50 border-green-200 text-green-600';
                fb.innerHTML = 'âœ¨ Puji Tuhan! Jawaban Kamu Benar! (+10)';
                scoreInGame += 10;
                points += 10;
                localStorage.setItem('sm_points', points);
                playTone(800, 0.3);
            } else {
                fb.className = 'mt-6 p-4 rounded-xl text-center font-bold text-lg border-2 bg-red-50 border-red-200 text-red-600';
                let txt = q.type === 'complex' ? q.answer.join(', ') : q.answer;
                if (q.type === 'match') txt = 'Semua pasangan harus terhubung dengan benar.';

                // Softer feedback message
                if (q.type === 'essay' && !isCorrect) {
                    fb.innerHTML = `Hmm, coba lagi ya. Kuncinya: "${q.answer}"`;
                } else if (q.type === 'match') {
                    fb.innerHTML = `Ayo semangat! ${txt}`;
                } else {
                    fb.innerHTML = `Yah, belum tepat. Jawabannya: <span class="font-black">${txt}</span>`;
                }
                playTone(200, 0.4, 'sawtooth');
            }

            updateUI();
            document.getElementById('submitBtn').classList.add('hidden');
            document.getElementById('nextBtn').classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) loadQuestion();
            else finishGame();
        }

        function finishGame() {
            // Save Session
            const sub = {
                id: Date.now(),
                name: userName,
                score: scoreInGame,
                answers: sessionAnswers,
                date: new Date().toLocaleString('id-ID')
            };
            allSubmissions.push(sub);
            localStorage.setItem('sm_submissions', JSON.stringify(allSubmissions));

            showSection('home');
            showModal('Selesai!', `Skor kamu: ${scoreInGame}. Total Poin: ${points}`);
        }

        // --- EDITOR LOGIC ---
        function updateEditorFields() {
            const t = document.getElementById('editType').value;
            const area = document.getElementById('editAnswerArea');
            area.innerHTML = '';

            if (t === 'choice' || t === 'complex') {
                // Dynamic inputs for options (A-D)
                let html = '<div class="space-y-2 mb-2"><label class="text-xs font-bold text-gray-400 uppercase">Pilihan Jawaban</label>';
                ['A', 'B', 'C', 'D'].forEach(l => {
                    html += `<input id="opt${l}" class="w-full p-2 rounded border text-sm option-input" placeholder="Opsi ${l}">`;
                });
                html += '</div>';

                // Key/Answer Input
                if (t === 'choice') {
                    html += `<input id="edKey" class="w-full p-2 rounded border text-sm" placeholder="Kunci Jawaban (Contoh: A atau teks jawaban)">`;
                } else {
                    html += `<input id="edKey" class="w-full p-2 rounded border text-sm" placeholder="Kunci Jawaban (Contoh: A, C atau teks)">`;
                    html += `<p class="text-[10px] text-gray-400 mt-1">*Untuk banyak jawaban, tulis teksnya dipisah koma.</p>`;
                }
                area.innerHTML = html;
            } else if (t === 'match') {
                area.innerHTML = `<textarea id="edPairs" class="w-full p-2 rounded border text-sm" rows="3" placeholder="Kiri:Kanan, A:B\nSatu pasangan per baris"></textarea>`;
            } else {
                area.innerHTML = `<input id="edKey" class="w-full p-2 rounded border text-sm" placeholder="Jawaban Benar">`;
            }
        }

        function addCustomQuestion() {
            const t = document.getElementById('editType').value;
            const q = document.getElementById('editQuestion').value;
            if (!q) return showModal('Eits', 'Pertanyaan belum diisi.');

            let obj = { id: Date.now(), type: t, question: q };

            if (t === 'choice' || t === 'complex') {
                // Collect options from inputs
                const opts = [];
                ['A', 'B', 'C', 'D'].forEach(l => {
                    const val = document.getElementById(`opt${l}`).value.trim();
                    if (val) opts.push(val);
                });

                if (opts.length < 2) return showModal('Kurang', 'Minimal isi 2 opsi pilihan.');
                obj.options = opts;

                const k = document.getElementById('edKey').value.trim();

                // Smart answer handling: if user types 'A', map to option index 0, etc.
                if (t === 'choice') {
                    if (['A', 'B', 'C', 'D'].includes(k.toUpperCase())) {
                        const idx = ['A', 'B', 'C', 'D'].indexOf(k.toUpperCase());
                        if (idx < opts.length) obj.answer = opts[idx];
                        else obj.answer = k;
                    } else {
                        obj.answer = k;
                    }
                } else {
                    // Complex (array)
                    obj.answer = k.split(',').map(s => {
                        const tr = s.trim();
                        if (['A', 'B', 'C', 'D'].includes(tr.toUpperCase())) {
                            const idx = ['A', 'B', 'C', 'D'].indexOf(tr.toUpperCase());
                            return idx < opts.length ? opts[idx] : tr;
                        }
                        return tr;
                    });
                }
            } else if (t === 'match') {
                const raw = document.getElementById('edPairs').value;
                if (!raw) return showModal('Kosong', 'Pasangan belum diisi.');

                // Split by newline or comma logic needs to be robust
                // Let's prefer newline for clarity as guided in placeholder
                let pairs = [];
                // Try splitting by newline first
                const lines = raw.split('\n');
                lines.forEach(line => {
                    if (line.includes(':')) {
                        const [l, r] = line.split(':');
                        if (l.trim() && r.trim()) pairs.push({ left: l.trim(), right: r.trim() });
                    } else if (line.includes(',')) { // fallback support for comma style within line? Or maybe user used commas for multiple pairs on one line
                        // Supporting legacy "A:B, C:D" style if newlines aren't used
                        const parts = line.split(',');
                        parts.forEach(p => {
                            const [l, r] = p.split(':');
                            if (l && r) pairs.push({ left: l.trim(), right: r.trim() });
                        });
                    }
                });

                if (pairs.length === 0) return showModal('Format Salah', 'Gunakan format Kiri:Kanan');
                obj.pairs = pairs;
            } else {
                obj.answer = document.getElementById('edKey').value.trim();
            }

            questions.push(obj);
            localStorage.setItem('sm_questions', JSON.stringify(questions));
            renderQuestionList();
            // Clear inputs
            document.getElementById('editQuestion').value = '';
            updateEditorFields();
            showModal('Sukses', 'Soal berhasil disimpan!');
        }

        function renderQuestionList() {
            const div = document.getElementById('questionList');
            div.innerHTML = '';
            questions.forEach(q => {
                div.innerHTML += `<div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-100 shadow-sm text-sm"><span class="truncate w-3/4"><b class="text-blue-500">[${q.type}]</b> ${q.question}</span><button onclick="deleteQ(${q.id})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            lucide.createIcons();
        }

        function deleteQ(id) { questions = questions.filter(q => q.id !== id); localStorage.setItem('sm_questions', JSON.stringify(questions)); renderQuestionList(); }
        function resetQuestions() {
            if (confirm("Apakah Anda yakin ingin menghapus semua soal buatan sendiri dan kembali ke pengaturan awal? Data tidak bisa dikembalikan.")) {
                localStorage.removeItem('sm_questions');
                location.reload();
            }
        }

        // --- GLOBAL UTILS ---
        function showSection(id) {
            ['roleSelection', 'studentLogin', 'teacherLogin', 'teacherDashboard', 'home', 'game', 'profileEditor', 'about'].forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
            if (id === 'teacherDashboard') {
                // Default to editor tab
                switchTeacherTab('editor');
            }
            updateUI();
        }

        function showModal(t, m) {
            document.getElementById('modalTitle').innerText = t;
            document.getElementById('modalMsg').innerText = m;
            if (!document.getElementById('modalActions').innerHTML.includes('Beli')) {
                document.getElementById('modalActions').innerHTML = `<button onclick="closeModal()" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold w-full hover:bg-black transition text-sm">Oke, Mengerti</button>`;
            }
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        window.onload = function () {
            showSection('roleSelection');
            updateUI();

            // UX: Support Enter key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    // Login Student
                    if (!document.getElementById('studentLogin').classList.contains('hidden') && document.activeElement.tagName === 'INPUT') {
                        enterStudentApp();
                    }
                    // Login Teacher
                    else if (!document.getElementById('teacherLogin').classList.contains('hidden') && document.activeElement.tagName === 'INPUT') {
                        enterTeacherApp();
                    }
                    // Submit Game Answer (not in textarea)
                    else if (!document.getElementById('game').classList.contains('hidden') && document.activeElement.tagName === 'INPUT') {
                        checkAnswer();
                    }
                }
            });
        };

    </script>
</body>

</html>